{% extends 'competitor/competitor_base.html' %}
{% load i18n %}
{% load static %}
{% load bootstrap5 %}
{% load eventtags %}

{% block title %}{% trans "Subscribe" %}{% endblock %}

{% block extra_head %}
    <style>
        .input-field label {

            margin-left: 10px;

        }
    </style>
{% endblock %}

{% block content %}
    <h1>Profile</h1>


    <div class="row">
        <div class=" col">

            <form id="subscribe_form" method="post" action=".">
                {% csrf_token %}


                <div class="row mb-3">
                    <p>Welcome {{ user.name }},</p>


{#                    {% get_content "profile_header" user as content %}#}
{#                <div class="mb-3">#}
                    {#                    {{ content|safe }}#}
{#                    Tell us a bit more about yourself - all fields are optional.#}
{#                </div>#}

                {% bootstrap_field form.country %}
                {% bootstrap_field form.city %}
                {% bootstrap_field form.where_did_you_hear %}


</div>


            </form>

            {% if USE_NEWSLETTER and not subcribed2newsletter %}
                <!-- Subscribe to Email List Section -->
                <div class="mb-3 email-subscription-section">
                    {% get_content "profile_why_signup" user as content %}
                    {% if content %}
                        <div class="mb-3">
                            {{ content|safe }}
                        </div>
{% endif %}

                    <div class="form-check fs-3 mb-3">
                        <form id="subscribe_me" method="post" action="{% url "newsapi:subscribe_me" %}">
                            {% csrf_token %}
                            <input type="hidden" name="email" value="{{ user.email }}">
                            <input type="hidden" name="consent_text" value="Get updates about DressageCalculator and Skorie">
                            <button id="subscribe_btn" type="submit" class="btn btn-primary">Send me occassional updates about DressageCalculator and Skorie </button>
                        </form>
                    </div>
                    <a href="{% url 'privacy' %}" class="mt-3">Read our Privacy Policy...</a>



                </div>

                <div class="row">
                    <div class=" col">Emails will be sent to: {{ user.email }}
                    </div>
                </div>
            {% endif %}


                <div class="mt-3">
                <button id="submit_profile" type="submit" form="about_form" class="btn btn-success">Save Profile</button>
                </div>


        </div>
    </div>

    <script src="{% static "js/jquery.validate.js" %}"></script>
    <script>

    $(document).on("click", '#submit_profile', function() {
            update_profile("{{ user.keycloak_id }}");
            document.location.href = "{{ next }}";
            return false;
        });

     $(document).on("change", '.form-control', function() {
            update_profile("{{ user.keycloak_id }}");
        });

        // DOCUMENTATION: https://jqueryvalidation.org/
        $("form").validate({
            rules: {
                email: {
                    required: true,
                    email: true
                },
            }
        });


function update_profile(user_pk) {
    var payload = {            'country': $("#id_country").val(),
        'profile': {
            'city': $("#id_city").val(),
            'where_did_you_hear': $("#id_where_did_you_hear").val(),
        }
    };

const url = "{% url 'usersapi:userprofile_update' '00000000-0000-0000-0000-000000000000' %}".replace("00000000-0000-0000-0000-000000000000", user_pk);

    $.ajax({
        method: "PATCH",
        url: url,
  data: JSON.stringify(payload),
        contentType: "application/json",
    })
        .done(function (data) {
            console.log("updated");
        });
}


          {% if USE_NEWSLETTER and not subcribed2newsletter %}

            $(document).on("submit", '#subscribe_me', function(e) {

                    e.preventDefault();

                    const $btn = $("#subscribe_btn");
                    const $status = $('#subscribe-status');
                    const prevText = $btn.text();
                    const url = SUBSCRIBE_ME_API_URL;

                    $btn.prop('disabled', true).text('Subscribing…');
                    $status.text('');

                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: new FormData(this),
                        processData: false,
                        contentType: false,

                        success: function (data, textStatus, jqXHR) {
                $btn.text('You are subscribed.');
                            $status.text("You are subscribed.");
                        },
                        error: function () {
                            $status.text('Sorry — something went wrong. Please try again later.');
                        },

                    });
                    });

        {% endif %}

    </script>
{% endblock %}
